    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>服务状态</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            html, body { height: 100%; overflow: hidden; }
            body {
                font-family: 'Consolas', 'Monaco', monospace;
                background: #fafaf9;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 15px;
            }
            .container {
                width: 100%;
                max-width: 1200px;
                height: calc(100vh - 30px);
                background: white;
                border-radius: 16px;
                padding: 30px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                display: flex;
                flex-direction: column;
            }
            h1 {
                color: #1a1a1a;
                font-size: 22px;
                font-weight: 600;
                margin-bottom: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 12px;
            }
            h1 img {
                width: 32px;
                height: 32px;
                border-radius: 8px;
            }
            .info-bar {
                background: #f9f9f9;
                border: 1px solid #e5e5e5;
                border-radius: 8px;
                padding: 12px 16px;
                margin-bottom: 16px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 12px;
            }
            .info-item {
                display: flex;
                align-items: center;
                gap: 6px;
                font-size: 13px;
                color: #6b6b6b;
            }
            .info-item strong { color: #1a1a1a; }
            .info-item a {
                color: #1a73e8;
                text-decoration: none;
                font-weight: 500;
            }
            .info-item a:hover { text-decoration: underline; }
            .stats {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
                margin-bottom: 16px;
            }
            .stat {
                background: #fafaf9;
                padding: 12px;
                border: 1px solid #e5e5e5;
                border-radius: 8px;
                text-align: center;
                transition: all 0.15s ease;
            }
            .stat:hover { border-color: #d4d4d4; }
            .stat-label { color: #6b6b6b; font-size: 11px; margin-bottom: 4px; }
            .stat-value { color: #1a1a1a; font-size: 18px; font-weight: 600; }
            .log-container {
                flex: 1;
                background: #fafaf9;
                border: 1px solid #e5e5e5;
                border-radius: 8px;
                padding: 12px;
                overflow-y: auto;
                scrollbar-width: thin;
                scrollbar-color: rgba(0,0,0,0.15) transparent;
            }
            .log-container::-webkit-scrollbar { width: 4px; }
            .log-container::-webkit-scrollbar-track { background: transparent; }
            .log-container::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.15);
                border-radius: 2px;
            }
            .log-container::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }
            .log-group {
                margin-bottom: 8px;
                border: 1px solid #e5e5e5;
                border-radius: 8px;
                background: white;
            }
            .log-group-header {
                padding: 10px 12px;
                background: #f9f9f9;
                border-radius: 8px 8px 0 0;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                transition: background 0.15s ease;
            }
            .log-group-header:hover { background: #f0f0f0; }
            .log-group-content { padding: 8px; }
            .log-entry {
                padding: 8px 10px;
                margin-bottom: 4px;
                background: white;
                border: 1px solid #e5e5e5;
                border-radius: 6px;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 13px;
                transition: all 0.15s ease;
            }
            .log-entry:hover { border-color: #d4d4d4; }
            .log-time { color: #6b6b6b; font-size: 12px; min-width: 140px; }
            .log-status {
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 11px;
                font-weight: 600;
                min-width: 60px;
                text-align: center;
            }
            .status-success { background: #d1fae5; color: #065f46; }
            .status-error { background: #fee2e2; color: #991b1b; }
            .status-in_progress { background: #fef3c7; color: #92400e; }
            .status-timeout { background: #fef3c7; color: #92400e; }
            .log-info { flex: 1; color: #374151; }
            .toggle-icon {
                display: inline-block;
                transition: transform 0.2s ease;
            }
            .toggle-icon.collapsed { transform: rotate(-90deg); }
            .subtitle-public {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }

            @media (max-width: 768px) {
                body { padding: 0; }
                .container {
                    padding: 15px;
                    height: 100vh;
                    border-radius: 0;
                    max-width: 100%;
                }
                h1 { font-size: 18px; margin-bottom: 12px; }
                .subtitle-public {
                    flex-direction: column;
                    gap: 6px;
                }
                .subtitle-public span {
                    font-size: 11px;
                    line-height: 1.6;
                }
                .subtitle-public a {
                    font-size: 12px;
                    font-weight: 600;
                }
                .info-bar {
                    padding: 10px 12px;
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 8px;
                }
                .info-item { font-size: 12px; }
                .stats {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 8px;
                    margin-bottom: 12px;
                }
                .stat { padding: 8px; }
                .stat-label { font-size: 10px; }
                .stat-value { font-size: 16px; }
                .log-container { padding: 8px; }
                .log-group { margin-bottom: 6px; }
                .log-group-header {
                    padding: 8px 10px;
                    font-size: 11px;
                    flex-wrap: wrap;
                }
                .log-group-header span { font-size: 10px !important; }
                .log-entry {
                    padding: 6px 8px;
                    font-size: 11px;
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 4px;
                }
                .log-time {
                    min-width: auto;
                    font-size: 10px;
                }
                .log-info {
                    font-size: 11px;
                    word-break: break-word;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>
                {% if logo_url %}<img src="{{ logo_url }}" alt="Logo">{% endif %}
                Gemini服务状态
            </h1>
            <div style="text-align: center; color: #999; font-size: 12px; margin-bottom: 16px;" class="subtitle-public">
                <span>展示最近1000条对话日志 · 每5秒自动更新</span>
                {% if chat_url %}<a href="{{ chat_url }}" target="_blank" style="color: #1a73e8; text-decoration: none;">开始对话</a>{% else %}<span style="color: #999;">开始对话</span>{% endif %}
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-label">总访问</div>
                    <div class="stat-value" id="stat-visitors">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">每分钟请求</div>
                    <div class="stat-value" id="stat-load">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">平均响应</div>
                    <div class="stat-value" id="stat-avg-time">-</div>
                </div>
                <div class="stat">
                    <div class="stat-label">成功率</div>
                    <div class="stat-value" id="stat-success-rate" style="color: #10b981;">-</div>
                </div>
                <div class="stat">
                    <div class="stat-label">对话次数</div>
                    <div class="stat-value" id="stat-total">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">成功</div>
                    <div class="stat-value" id="stat-success" style="color: #10b981;">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">失败</div>
                    <div class="stat-value" id="stat-error" style="color: #ef4444;">0</div>
                </div>
                <div class="stat">
                    <div class="stat-label">更新时间</div>
                    <div class="stat-value" id="stat-update-time" style="font-size: 14px; color: #6b6b6b;">--:--</div>
                </div>
            </div>
            <div class="log-container" id="log-container">
                <div style="text-align: center; color: #999; padding: 20px;">加载中...</div>
            </div>
        </div>
        <script>
            async function loadData() {
                try {
                    // 并行加载日志和统计数据
                    const [logsResponse, statsResponse] = await Promise.all([
                        fetch('/public/log?limit=1000'),
                        fetch('/public/stats')
                    ]);

                    const logsData = await logsResponse.json();
                    const statsData = await statsResponse.json();

                    displayLogs(logsData.logs);
                    updateStats(logsData.logs, statsData);
                } catch (error) {
                    document.getElementById('log-container').innerHTML = '<div style="text-align: center; color: #f44336; padding: 20px;">加载失败: ' + error.message + '</div>';
                }
            }

            function displayLogs(logs) {
                const container = document.getElementById('log-container');
                if (logs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无日志</div>';
                    return;
                }

                // 读取折叠状态
                const foldState = JSON.parse(localStorage.getItem('public-log-fold-state') || '{}');

                let html = '';
                logs.forEach(log => {
                    const reqId = log.request_id;

                    // 状态图标和颜色
                    let statusColor = '#ff9800';
                    let statusText = '进行中';

                    if (log.status === 'success') {
                        statusColor = '#4caf50';
                        statusText = '成功';
                    } else if (log.status === 'error') {
                        statusColor = '#f44336';
                        statusText = '失败';
                    } else if (log.status === 'timeout') {
                        statusColor = '#ffc107';
                        statusText = '超时';
                    }

                    // 检查折叠状态
                    const isCollapsed = foldState[reqId] === true;
                    const contentStyle = isCollapsed ? 'style="display: none;"' : '';
                    const iconClass = isCollapsed ? 'class="toggle-icon collapsed"' : 'class="toggle-icon"';

                    // 构建事件列表
                    let eventsHtml = '';
                    log.events.forEach(event => {
                        let eventClass = 'log-entry';
                        let eventLabel = '';

                        if (event.type === 'start') {
                            eventLabel = '<span style="color: #2563eb; font-weight: 600;">开始对话</span>';
                        } else if (event.type === 'select') {
                            eventLabel = '<span style="color: #8b5cf6; font-weight: 600;">选择</span>';
                        } else if (event.type === 'retry') {
                            eventLabel = '<span style="color: #f59e0b; font-weight: 600;">重试</span>';
                        } else if (event.type === 'switch') {
                            eventLabel = '<span style="color: #06b6d4; font-weight: 600;">切换</span>';
                        } else if (event.type === 'complete') {
                            if (event.status === 'success') {
                                eventLabel = '<span style="color: #10b981; font-weight: 600;">完成</span>';
                            } else if (event.status === 'error') {
                                eventLabel = '<span style="color: #ef4444; font-weight: 600;">失败</span>';
                            } else if (event.status === 'timeout') {
                                eventLabel = '<span style="color: #f59e0b; font-weight: 600;">超时</span>';
                            }
                        }

                        eventsHtml += `
                            <div class="${eventClass}">
                                <div class="log-time">${event.time}</div>
                                <div style="min-width: 60px;">${eventLabel}</div>
                                <div class="log-info">${event.content}</div>
                            </div>
                        `;
                    });

                    html += `
                        <div class="log-group" data-req-id="${reqId}">
                            <div class="log-group-header" onclick="toggleGroup('${reqId}')">
                                <span style="color: ${statusColor}; font-weight: 600; font-size: 11px;">⬤ ${statusText}</span>
                                <span style="color: #666; font-size: 11px; margin-left: 8px;">req_${reqId}</span>
                                <span style="color: #999; font-size: 11px; margin-left: 8px;">${log.events.length}条事件</span>
                                <span ${iconClass} style="margin-left: auto; color: #999;">▼</span>
                            </div>
                            <div class="log-group-content" ${contentStyle}>
                                ${eventsHtml}
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            function updateStats(logs, statsData) {
                const total = logs.length;
                const successLogs = logs.filter(log => log.status === 'success');
                const success = successLogs.length;
                const error = logs.filter(log => log.status === 'error').length;

                // 计算平均响应时间
                let avgTime = '-';
                if (success > 0) {
                    let totalDuration = 0;
                    let count = 0;
                    successLogs.forEach(log => {
                        log.events.forEach(event => {
                            if (event.type === 'complete' && event.content.includes('耗时')) {
                                const match = event.content.match(/([\d.]+)s/);
                                if (match) {
                                    totalDuration += parseFloat(match[1]);
                                    count++;
                                }
                            }
                        });
                    });
                    if (count > 0) {
                        avgTime = (totalDuration / count).toFixed(1) + 's';
                    }
                }

                // 计算成功率
                const totalCompleted = success + error;
                const successRate = totalCompleted > 0 ? ((success / totalCompleted) * 100).toFixed(1) + '%' : '-';

                // 更新日志统计
                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-success').textContent = success;
                document.getElementById('stat-error').textContent = error;
                document.getElementById('stat-success-rate').textContent = successRate;
                document.getElementById('stat-avg-time').textContent = avgTime;

                // 更新全局统计
                document.getElementById('stat-visitors').textContent = statsData.total_visitors;

                // 更新负载状态（带颜色）
                const loadElement = document.getElementById('stat-load');
                loadElement.textContent = statsData.requests_per_minute;
                loadElement.style.color = statsData.load_color;

                // 更新时间
                document.getElementById('stat-update-time').textContent = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
            }

            function toggleGroup(reqId) {
                const group = document.querySelector(`.log-group[data-req-id="${reqId}"]`);
                const content = group.querySelector('.log-group-content');
                const icon = group.querySelector('.toggle-icon');

                const isCollapsed = content.style.display === 'none';
                if (isCollapsed) {
                    content.style.display = 'block';
                    icon.classList.remove('collapsed');
                } else {
                    content.style.display = 'none';
                    icon.classList.add('collapsed');
                }

                // 保存折叠状态
                const foldState = JSON.parse(localStorage.getItem('public-log-fold-state') || '{}');
                foldState[reqId] = !isCollapsed;
                localStorage.setItem('public-log-fold-state', JSON.stringify(foldState));
            }

            // 初始加载
            loadData();

            // 自动刷新（每5秒）
            setInterval(loadData, 5000);
        </script>
    </body>
    </html>
